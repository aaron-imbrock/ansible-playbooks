---
- name: Debian OS Updates and base packages
  hosts: all
  become: yes
  tasks:
    - name: Set timezone to UTC
      ansible.builtin.timezone:
        name: UTC

    - name: Set default search domain to sizza.net
      ansible.builtin.lineinfile:
        path: /etc/resolv.conf
        line: "search sizza.net"
        create: yes
        state: present

    - name: Disable install recommends and suggests
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/80no-install-recommends
        content: |
          APT::Install-Recommends "0";
          APT::Install-Suggests "0";
          
    - name: Update Base OS
      ansible.builtin.apt:
        update_cache: yes
        upgrade: full
        autoclean: yes

    - name: Add VSCODE repository key
      ansible.builtin.apt_key:
        url: https://packages.microsoft.com/keys/microsoft.asc
        state: present

    - name: Add VSCODE repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main"
        state: present

    - name: Add Sublime repository key
      ansible.builtin.apt_key:
        url: https://download.sublimetext.com/sublimehq-pub.gpg
        state: present

    - name: Add Sublime repository
      ansible.builtin.apt_repository:
        repo: "deb https://download.sublimetext.com/ apt/stable/"
        state: present

    # - name: Add Node repository setup script
    #   command: curl -fsSL https://deb.nodesource.com/setup_current.x | bash -
    #   args:
    #     warn: false

    - name: Update apt cache after adding repositories
      ansible.builtin.apt:
        update_cache: yes

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - software-properties-common
          - apt-transport-https
          - curl
          - git
          - vim
          - build-essential
          - fonts-inconsolata
          - code
          - sublime-text
          - keepass2
          - ca-certificates
          - debsig-verify
          - ttf-mscorefonts-installer
          - tree
          - python3-pip
          - ansible
          - rsync
          - brightnessctl
          - alacritty
          - pipx
        state: present

    # - name: Install npm packages
    #   npm:
    #     name:
    #       - live-server
    #       - eslint
    #     global: yes

    - name: Clear and regenerate font cache
      command: fc-cache -fv
      args:
        warn: false

    # - name: Verify Inconsolata font is installed
    #   command: fc-list | grep -i consolata
    #   args:
    #     warn: false

    # - name: Install pipx
    #   ansible.builtin.apt:
    #     name: pipx
    #     state: present

    - name: Ensure pipx path is set
      pipx:
        ensurepath: yes

    - name: Install Poetry using pipx
      pipx:
        name: poetry
